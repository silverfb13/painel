<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Painel IPTV</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 800px;
    margin: 40px auto;
    background: #f9f9f9;
    color: #333;
  }
  h1 {
    text-align: center;
  }
  form {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }
  input[type=text], input[type=password] {
    padding: 8px;
    font-size: 16px;
    width: 200px;
  }
  button {
    padding: 10px 15px;
    font-size: 16px;
    cursor: pointer;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: center;
  }
  th {
    background: #3f51b5;
    color: white;
  }
  td button {
    padding: 5px 10px;
    font-size: 14px;
  }
  td input {
    width: 90%;
    padding: 5px;
    box-sizing: border-box;
  }
</style>
</head>
<body>

<h1>Painel de Usuários IPTV</h1>

<form id="formAdicionar">
  <input type="text" id="inputUsuario" placeholder="Usuário" required />
  <input type="password" id="inputSenha" placeholder="Senha" required />
  <button type="submit">Adicionar Usuário</button>
</form>

<table>
  <thead>
    <tr>
      <th>Usuário</th>
      <th>Senha</th>
      <th>Editar</th>
      <th>Remover</th>
    </tr>
  </thead>
  <tbody id="usuariosBody">
    <tr><td colspan="4">Carregando...</td></tr>
  </tbody>
</table>

<script>
  const repo = "silverfb13/painel"; // seu repo no GitHub
  const arquivo = "usuarios.json";   // nome do arquivo JSON no repo

  // TOKEN CIFRADO COM CÉSAR +3 (substitua pelo seu token cifrado)
  const tokenCifrado = "jlwkxe_sdw_11EPGROHT0ts2JPL5CEpnJ_zO0kHyWPBCOS4fKYbU12Dh7hKKlc6JtU277BPxn9CLLNAQ5PGSS7WRVx7WV"; // Exemplo, troque aqui!

  // Função para decifrar César -3 (somente letras)
  function decifraCesarMenos3(texto) {
    return texto.split('').map(c => {
      const code = c.charCodeAt(0);
      if (code >= 65 && code <= 90) {
        return String.fromCharCode(((code - 65 + 26 - 3) % 26) + 65);
      }
      if (code >= 97 && code <= 122) {
        return String.fromCharCode(((code - 97 + 26 - 3) % 26) + 97);
      }
      return c;
    }).join('');
  }

  const token = decifraCesarMenos3(tokenCifrado);

  let usuarios = {};
  let shaArquivo = null; // para atualização do arquivo no GitHub

  const tbody = document.getElementById("usuariosBody");
  const form = document.getElementById("formAdicionar");
  const inputUsuario = document.getElementById("inputUsuario");
  const inputSenha = document.getElementById("inputSenha");

  // Função para atualizar a tabela da página com os usuários atuais
  function atualizarTabela() {
    tbody.innerHTML = "";
    if (Object.keys(usuarios).length === 0) {
      tbody.innerHTML = '<tr><td colspan="4">Nenhum usuário cadastrado</td></tr>';
      return;
    }
    for (const user in usuarios) {
      const tr = document.createElement("tr");

      const tdUser = document.createElement("td");
      tdUser.textContent = user;
      tr.appendChild(tdUser);

      const tdSenha = document.createElement("td");
      const inputSenhaEdit = document.createElement("input");
      inputSenhaEdit.type = "text";
      inputSenhaEdit.value = usuarios[user];
      inputSenhaEdit.addEventListener("change", e => {
        usuarios[user] = e.target.value;
        salvarUsuarios();
      });
      tdSenha.appendChild(inputSenhaEdit);
      tr.appendChild(tdSenha);

      const tdEditar = document.createElement("td");
      tdEditar.textContent = "Edita a senha acima";
      tr.appendChild(tdEditar);

      const tdRemover = document.createElement("td");
      const btnRemover = document.createElement("button");
      btnRemover.textContent = "Remover";
      btnRemover.style.background = "#e53935";
      btnRemover.style.color = "white";
      btnRemover.addEventListener("click", () => {
        if(confirm(`Remover o usuário "${user}"?`)) {
          delete usuarios[user];
          salvarUsuarios();
        }
      });
      tdRemover.appendChild(btnRemover);
      tr.appendChild(tdRemover);

      tbody.appendChild(tr);
    }
  }

  // Função para carregar usuários do GitHub via API
  async function carregarUsuarios() {
    try {
      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${arquivo}`, {
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: 'application/vnd.github.v3+json'
        }
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(`Erro ao buscar arquivo: ${res.status} ${res.statusText} - ${err.message || JSON.stringify(err)}`);
      }
      const json = await res.json();
      shaArquivo = json.sha;
      const conteudo = atob(json.content);
      usuarios = JSON.parse(conteudo);
      atualizarTabela();
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="4" style="color:red;">${e.message}</td></tr>`;
    }
  }

  // Função para salvar o arquivo usuarios.json no GitHub via API
  async function salvarUsuarios() {
    try {
      const conteudoNovo = btoa(JSON.stringify(usuarios, null, 2));
      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${arquivo}`, {
        method: 'PUT',
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: 'application/vnd.github.v3+json'
        },
        body: JSON.stringify({
          message: 'Atualizando usuarios.json via painel',
          content: conteudoNovo,
          sha: shaArquivo
        })
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(`Erro ao salvar arquivo: ${res.status} ${res.statusText} - ${err.message || JSON.stringify(err)}`);
      }
      const json = await res.json();
      shaArquivo = json.content.sha; // atualizar o sha para próxima edição
      atualizarTabela();
      alert("Usuários atualizados com sucesso!");
    } catch (e) {
      alert(`Erro ao salvar: ${e.message}`);
    }
  }

  // Evento ao enviar o form para adicionar usuário
  form.addEventListener("submit", e => {
    e.preventDefault();
    const user = inputUsuario.value.trim();
    const senha = inputSenha.value.trim();
    if (!user || !senha) {
      alert("Usuário e senha são obrigatórios.");
      return;
    }
    if (usuarios[user]) {
      alert("Usuário já existe!");
      return;
    }
    usuarios[user] = senha;
    salvarUsuarios();
    inputUsuario.value = "";
    inputSenha.value = "";
  });

  // Inicia carregando os usuários
  carregarUsuarios();
</script>

</body>
</html>
